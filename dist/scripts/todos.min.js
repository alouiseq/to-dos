$(document).ready(function(){var a=new TasksViewModel;ko.applyBindings(a);a.populate("daily");a.populate("project")});function TableRow(a,b,c,d,e){this._id=a;this.rank=b;this.term=c;this.entry=ko.observable(d);this.status=ko.observable(e);this.selected=ko.observable(false);this.edit=function(){this.selected(true)};this.editText=function(a,b){if(b.which===13){this.selected(false);$.get("/textEdit/"+this.entry()+"/"+this._id,function(a){if(a.msg!==null){console.log("ERROR: "+a.msg)}else{console.log("UPDATE SUCCESSFUL!")}})}}}function TasksViewModel(){var a=this,b={daily:0,project:1},c={daily:1,project:1},d="",e="",f="",g,h=0,i={},j={};a.ranks={daily:[],project:[]};a.rlimits={daily:20,project:10};a.entry_daily=ko.observable("");a.entry_project=ko.observable("");a.status=["incomplete","completed","removed"];a.table={daily_entries:ko.observableArray(),project_entries:ko.observableArray()};a.populate=function(c){$.getJSON("/entrylist",function(d){var e=d.filter(function(b){if(b.term===c){a.ranks[c].push(b.rank);return b}});var f=e.sort(function(a,b){if(a.rank<b.rank){return-1}if(a.rank>b.rank){return 1}alert("Rank collision with "+a.rank+" and "+b.rank+"..."+"Aborting now!")});$.each(f,function(d,e){var f=new TableRow(e._id,e.rank,e.term,e.entry,e.status);a.table[c+"_entries"].push(f);if(e._id>=b[c]){b[c]=e._id+2}})})};a.addCell=function(f,g,k){if(k.which==13){d="entry_"+f;e=f+"_entries";for(var l=1;l<=a.rlimits[f];l++){if(a.ranks[f].indexOf(l)===-1){h=l;a.ranks[f].push(l);break}}if(!h){h=c[f]++}i=new TableRow(b[f],h,f,g[d](),a.status[0]);b[f]=b[f]+2;a.table[e].push(i);j=ko.toJSON(i);$.post("/addentry",j,function(a){if(a.msg!==""){alert("Add Error: "+a.msg)}},"json");g[d]("")}};a.addSlideDown=function(a,b,c){$(a).find("div").hide().slideDown()};a.removeCell=function(b,c,d){e=b+"_entries";g=a.ranks[b].indexOf(d.rank);a.ranks[b].splice(g,1);a.ranks[b].forEach(function(a,b){if(a>g){a--}});a.table[e].remove(d);$.ajax({url:"/deleteEntry/"+d._id+"/"+d.rank+"/"+d.term,type:"DELETE",success:function(a){if(a.msg!==""){alert("Delete Error: "+a.msg)}}})};a.removeSlideUp=function(a,b,c){$(a).find("div").slideUp(function(){$(a).remove()})};a.toggleStatus=function(b){if(b.status()==a.status[0]){f=a.status[1]}else{f=a.status[0]}b.status(f);$.get("/updateEntry/"+b._id+"/"+f,function(a){if(a.msg!==""){alert("Update Error: "+a.msg)}})};ko.bindingHandlers.sortableTable={init:function(a,b,c){$(a).sortable({update:function(a,d){var e=c.get("term");var f=b();var g=ko.dataFor(d.item[0]);var h=d.item.parent().children().index(d.item);f.remove(g);f.splice(h,0,g);var i={item:g,position:h,term:e},j=JSON.stringify(i);$.post("/addsorted",j,function(a){if(a!==null){alert("ERROR post to addsorted: "+a.msg)}})}})}}}